<!--pages/cart/index.wxml-->
<view class="container">
  <view class="cart-header">
    <view class="cart-title">购物车</view>
    <view class="manage-btn" bindtap="toggleEditMode" wx:if="{{cartList.length > 0}}">
      {{isEdit ? '完成' : '管理'}}
    </view>
  </view>
  
  <block wx:if="{{isLogin}}">
    <view wx:if="{{loadingStatus}}" class="loading">
      <van-loading type="spinner" size="24px" />
    </view>
    
    <block wx:elif="{{cartList.length > 0}}">
      <view class="cart-list">
        <view class="cart-item" wx:for="{{cartList}}" wx:key="id" wx:for-index="index">
          <view class="checkbox-wrapper" bindtap="onToggleItem" data-id="{{item.id}}" data-selected="{{item.selected}}">
            <van-checkbox value="{{item.selected}}" catch:tap="onToggleItem" data-id="{{item.id}}" data-selected="{{item.selected}}" class="checkbox" />
          </view>
          <view class="goods-info">
            <image class="goods-image" src="{{item.goodsInfo.main_image || '/assets/images/placeholder.png'}}" mode="aspectFill" binderror="onImageError" data-index="{{index}}"></image>
            <view class="goods-detail">
              <view class="goods-name">{{item.goodsInfo.name}}</view>
              <view class="goods-spec" wx:if="{{item.goodsSpec}}">规格: {{item.goodsSpec}}</view>
              <view class="goods-price">¥{{item.goodsInfo.price}}</view>
              <view class="goods-quantity">
                <van-stepper value="{{item.count}}" min="1" max="{{item.goodsInfo.stock || 99}}" bind:change="onChangeQuantity" data-id="{{item.id}}" />
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 底部操作区 -->
      <view class="cart-footer">
        <view class="footer-left">
          <van-checkbox value="{{checkedAll}}" bind:change="onToggleAll" class="checkbox">全选</van-checkbox>
        </view>
        <view class="footer-right">
          <block wx:if="{{!isEdit}}">
            <view class="total-info">
              <text>合计: </text>
              <text class="price">¥{{checkedTotalPrice}}</text>
            </view>
            <view class="checkout-btn" bindtap="onSubmit">
              结算({{checkedTotalCount}})
            </view>
          </block>
          <block wx:else>
            <view class="delete-btn" bindtap="deleteSelected">
              删除
            </view>
          </block>
        </view>
      </view>
    </block>
    
    <view wx:else class="empty-cart">
      <van-empty description="购物车是空的" />
      <view class="start-shopping" bindtap="goShopping">去购物</view>
    </view>
  </block>
  
  <view wx:else class="not-login">
    <van-empty description="请先登录" />
    <view class="login-btn" bindtap="goToLogin">去登录</view>
  </view>
  
  <!-- 调试信息 -->
  <view class="debug-info" wx:if="{{cartList.length > 0 && __debug__}}">
    <view>购物车项数: {{cartList.length}}</view>
    <view wx:if="{{cartList[0]}}">
      <view>第一项ID: {{cartList[0].id}}</view>
      <view>商品ID: {{cartList[0].goodsId}}</view>
      <view>商品名称: {{cartList[0].goodsInfo.name}}</view>
      <view>图片URL: {{cartList[0].goodsInfo.main_image}}</view>
      <view>价格: {{cartList[0].goodsInfo.price}}</view>
    </view>
  </view>
</view>