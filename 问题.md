# å•†åŸå°ç¨‹åºé¡¹ç›®é—®é¢˜è®°å½•

## å‰ç«¯APIè¯·æ±‚æ— æ³•è®¿é—®åç«¯é—®é¢˜

### é—®é¢˜æè¿°
åœ¨å‰ç«¯åº”ç”¨(3000ç«¯å£)ä¸­å°è¯•è®¿é—®åç«¯API(8080ç«¯å£)çš„ç®¡ç†å‘˜ç™»å½•æ¥å£æ—¶ï¼Œæ”¶åˆ°404é”™è¯¯ï¼š
```json
{"status": "fail", "message": "è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨"}
```

### é—®é¢˜åŸå› 
1. å‰ç«¯ä½¿ç”¨äº†é”™è¯¯çš„ç«¯å£å·(3000)æ¥è®¿é—®åç«¯æœåŠ¡(8080)
2. Viteä»£ç†é…ç½®ä¸­çš„rewriteè§„åˆ™å¯¼è‡´APIè·¯å¾„è¢«é”™è¯¯å¤„ç†ï¼š
```javascript
rewrite: (path) => path.replace(/^\/api/, '')
```
è¿™å¯¼è‡´å‘é€åˆ°'/api/admin/login'çš„è¯·æ±‚è¢«è½¬å‘åˆ°åç«¯çš„'/admin/login'ï¼Œè€Œä¸æ˜¯é¢„æœŸçš„'/api/admin/login'

### è§£å†³æ–¹æ¡ˆ
ä¿ç•™åç«¯APIåœ¨8080ç«¯å£è¿è¡Œï¼Œä¿®æ”¹å‰ç«¯Viteé…ç½®ä¸­çš„ä»£ç†è®¾ç½®ï¼Œç§»é™¤rewriteè§„åˆ™ï¼š
```javascript
proxy: {
  '/api': {
    target: env.API_URL || 'http://localhost:8080',
    changeOrigin: true,
    // ç§»é™¤rewriteä»¥ç¡®ä¿è·¯å¾„èƒ½æ­£ç¡®ä¼ é€’åˆ°åç«¯
    // rewrite: (path) => path.replace(/^\/api/, ''),
  },
}
```

## JWTä»¤ç‰Œç”Ÿæˆå¤±è´¥é—®é¢˜

### é—®é¢˜æè¿°
ä¿®å¤APIä»£ç†é…ç½®åï¼Œç”¨æˆ·æˆåŠŸè¿æ¥åˆ°åç«¯APIï¼Œä½†åœ¨ç™»å½•æ—¶æ”¶åˆ°ä»¥ä¸‹é”™è¯¯ï¼š
```json
{
  "status": "error",
  "message": "ä»¤ç‰Œç”Ÿæˆå¤±è´¥",
  "error": {
    "statusCode": 500,
    "status": "error"
  },
  "stack": "Error: ä»¤ç‰Œç”Ÿæˆå¤±è´¥\n    at generateToken (/Users/zhuanghaixin/WebstormProjects/cursor_code/å•†åŸå°ç¨‹åº/mall-server/src/utils/jwtToken.js:22:15)\n    at /Users/zhuanghaixin/WebstormProjects/cursor_code/å•†åŸå°ç¨‹åº/mall-server/src/controllers/adminController.js:175:19\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)",
  "errorCode": ""
}
```

### é—®é¢˜åŸå› 
é€šè¿‡æ£€æŸ¥jwtToken.jsæ–‡ä»¶å’Œç¯å¢ƒå˜é‡é…ç½®ï¼Œå‘ç°ç™»å½•å¤±è´¥æ˜¯å› ä¸ºç¼ºå°‘JWTç›¸å…³çš„ç¯å¢ƒå˜é‡é…ç½®ï¼š
- è™½ç„¶åœ¨.envæ–‡ä»¶ä¸­å­˜åœ¨JWTé…ç½®ï¼Œä½†åœ¨.env.developmentä¸­ç¼ºå°‘è¿™äº›é…ç½®
- JWTä»¤ç‰Œç”Ÿæˆéœ€è¦JWT_SECRETï¼ˆå¯†é’¥ï¼‰å’ŒJWT_EXPIRES_INï¼ˆè¿‡æœŸæ—¶é—´ï¼‰å‚æ•°

### è§£å†³æ–¹æ¡ˆ
åœ¨.env.developmentæ–‡ä»¶ä¸­æ·»åŠ JWTé…ç½®ï¼š
```
# JWTé…ç½®
JWT_SECRET=dev_secret_key_for_jwt_token_2023
JWT_EXPIRES_IN=7d
```

é‡å¯å¼€å‘æœåŠ¡å™¨åï¼Œç®¡ç†å‘˜ç™»å½•åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œèƒ½å¤ŸæˆåŠŸç”ŸæˆJWTä»¤ç‰Œå¹¶ç™»å½•ã€‚

## ç®¡ç†å‘˜è´¦æˆ·é…ç½®é—®é¢˜

### é—®é¢˜æè¿°
éœ€è¦ä¸ºç³»ç»Ÿè®¾ç½®é»˜è®¤çš„ç®¡ç†å‘˜è´¦æˆ·ï¼Œä»¥ä¾¿åˆå§‹åŒ–åå¯ä»¥ç™»å½•ç®¡ç†åå°ã€‚

### è§£å†³æ–¹æ¡ˆ
é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼Œåœ¨.env.developmentæ–‡ä»¶ä¸­æ·»åŠ ï¼š
```
# é»˜è®¤ç®¡ç†å‘˜é…ç½®
ADMIN_USERNAME=dev_admin
ADMIN_PASSWORD=dev_pass123
ADMIN_REAL_NAME=å¼€å‘ç¯å¢ƒç®¡ç†å‘˜
ADMIN_EMAIL=dev@example.com
```

åœ¨ç”Ÿäº§ç¯å¢ƒ(.env.production)ä¸­ä½¿ç”¨æ›´å®‰å…¨çš„å¯†ç ï¼š
```
# é»˜è®¤ç®¡ç†å‘˜é…ç½®
ADMIN_USERNAME=admin
ADMIN_PASSWORD=Secure@Pr0d#Pass!23
ADMIN_REAL_NAME=ç³»ç»Ÿç®¡ç†å‘˜
ADMIN_EMAIL=admin@yourcompany.com
```

å¹¶ä¿®æ”¹ç®¡ç†å‘˜åˆ›å»ºå‡½æ•°(adminController.js)ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š
```javascript
await Admin.create({
    username: process.env.ADMIN_USERNAME || 'superadmin',
    password: process.env.ADMIN_PASSWORD || 'superpass123!',
    realName: process.env.ADMIN_REAL_NAME || 'è¶…çº§ç®¡ç†å‘˜',
    email: process.env.ADMIN_EMAIL || 'admin@example.com',
    role: 'admin',
    status: 'active'
});
```

## JWTåœ¨Node.js Expressåº”ç”¨ä¸­çš„æ ¸å¿ƒæµç¨‹

### ä»€ä¹ˆæ˜¯JWT
JSON Web Token (JWT) æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡† (RFC 7519)ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚JWTå¯ä»¥è¢«ç­¾åï¼ˆä½¿ç”¨å¯†é’¥ï¼‰ä»¥ç¡®ä¿å…¶å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚åœ¨Webåº”ç”¨ä¸­ï¼ŒJWTé€šå¸¸ç”¨äºæ— çŠ¶æ€çš„ç”¨æˆ·èº«ä»½éªŒè¯å’Œä¿¡æ¯äº¤æ¢ã€‚

### JWTçš„ç»“æ„
JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä»¥ç‚¹ï¼ˆ.ï¼‰åˆ†éš”ï¼š
1. **Headerï¼ˆå¤´éƒ¨ï¼‰**ï¼šåŒ…å«ä»¤ç‰Œç±»å‹å’Œä½¿ç”¨çš„ç­¾åç®—æ³•
2. **Payloadï¼ˆè´Ÿè½½ï¼‰**ï¼šåŒ…å«å£°æ˜ï¼ˆç”¨æˆ·ä¿¡æ¯å’Œå…ƒæ•°æ®ï¼‰
3. **Signatureï¼ˆç­¾åï¼‰**ï¼šç”¨äºéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§

ä¾‹å¦‚ï¼š`xxxxx.yyyyy.zzzzz`

### åœ¨Expressåº”ç”¨ä¸­å®ç°JWTçš„æ ¸å¿ƒæµç¨‹

#### 1. å®‰è£…å¿…è¦çš„åŒ…
```bash
npm install jsonwebtoken bcryptjs express
```

#### 2. ä»¤ç‰Œç”Ÿæˆæµç¨‹
å½“ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ç”ŸæˆJWTä»¤ç‰Œï¼š

```javascript
// jwtToken.js
const jwt = require('jsonwebtoken');

/**
 * ç”ŸæˆJWTä»¤ç‰Œ
 * @param {Object} payload - è¦åŒ…å«åœ¨ä»¤ç‰Œä¸­çš„æ•°æ®
 * @param {string} secret - ç”¨äºç­¾åçš„å¯†é’¥
 * @param {string|number} expiresIn - ä»¤ç‰Œè¿‡æœŸæ—¶é—´
 * @returns {string} JWTä»¤ç‰Œ
 */
const generateToken = (payload, secret = process.env.JWT_SECRET, expiresIn = process.env.JWT_EXPIRES_IN) => {
  try {
    return jwt.sign(payload, secret, { expiresIn });
  } catch (error) {
    throw new Error('ä»¤ç‰Œç”Ÿæˆå¤±è´¥');
  }
};

module.exports = { generateToken };
```

åœ¨ç™»å½•æ§åˆ¶å™¨ä¸­ä½¿ç”¨ï¼š
```javascript
// authController.js
const { generateToken } = require('../utils/jwtToken');

exports.login = async (req, res) => {
  try {
    const { username, password } = req.body;
    
    // 1. æŸ¥æ‰¾ç”¨æˆ·
    const user = await User.findOne({ where: { username } });
    
    // 2. éªŒè¯å¯†ç 
    if (!user || !(await user.comparePassword(password))) {
      return res.status(401).json({
        status: 'fail',
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
    }
    
    // 3. ç”ŸæˆJWTä»¤ç‰Œ
    const token = generateToken({
      id: user.id,
      username: user.username,
      role: user.role
    });
    
    // 4. è¿”å›ä»¤ç‰Œå’Œç”¨æˆ·ä¿¡æ¯
    res.status(200).json({
      status: 'success',
      message: 'ç™»å½•æˆåŠŸ',
      data: { user, token }
    });
  } catch (error) {
    res.status(500).json({
      status: 'error',
      message: error.message
    });
  }
};
```

#### 3. éªŒè¯ä¸­é—´ä»¶å®ç°
åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶æ¥éªŒè¯è¯·æ±‚ä¸­çš„JWTä»¤ç‰Œï¼š

```javascript
// authMiddleware.js
const { verifyToken } = require('../utils/jwtToken');

exports.protect = (req, res, next) => {
  try {
    // 1. ä»è¯·æ±‚å¤´è·å–ä»¤ç‰Œ
    const authHeader = req.headers.authorization;
    let token;
    
    if (authHeader && authHeader.startsWith('Bearer ')) {
      token = authHeader.split(' ')[1];
    }
    
    // 2. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦å­˜åœ¨
    if (!token) {
      return res.status(401).json({
        status: 'fail',
        message: 'æ‚¨æœªç™»å½•ï¼Œè¯·ç™»å½•åè®¿é—®'
      });
    }
    
    // 3. éªŒè¯ä»¤ç‰Œ
    const decoded = verifyToken(token);
    
    // 4. å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    req.user = decoded;
    
    // 5. ç»§ç»­ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    next();
  } catch (error) {
    res.status(401).json({
      status: 'fail',
      message: error.message
    });
  }
};

// æƒé™æ§åˆ¶ä¸­é—´ä»¶
exports.restrictTo = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({
        status: 'fail',
        message: 'æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ'
      });
    }
    next();
  };
};
```

#### 4. åº”ç”¨åˆ°è·¯ç”±
åœ¨Expressè·¯ç”±ä¸­åº”ç”¨JWTä¸­é—´ä»¶ï¼š

```javascript
// routes.js
const express = require('express');
const authController = require('../controllers/authController');
const { protect, restrictTo } = require('../middlewares/authMiddleware');

const router = express.Router();

// å…¬å¼€è·¯ç”±
router.post('/login', authController.login);
router.post('/register', authController.register);

// éœ€è¦èº«ä»½è®¤è¯çš„è·¯ç”±
router.use(protect); // åº”ç”¨JWTéªŒè¯ä¸­é—´ä»¶

// è·å–ç”¨æˆ·ä¸ªäººèµ„æ–™
router.get('/profile', userController.getProfile);

// éœ€è¦ç‰¹å®šè§’è‰²çš„è·¯ç”±
router.delete('/users/:id', restrictTo('admin'), userController.deleteUser);

module.exports = router;
```

### JWTè®¤è¯æµç¨‹å›¾
#### æ ¸å¿ƒæµç¨‹â€‹â€‹
â€‹ç”¨æˆ·ç™»å½•â€‹â€‹ â†’ æœåŠ¡ç«¯ç”Ÿæˆ JWT â†’ è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ 

å®¢æˆ·ç«¯å­˜å‚¨ JWTâ€‹â€‹ï¼ˆå¦‚ localStorage æˆ– Cookieï¼‰ã€‚

â€‹åç»­è¯·æ±‚æºå¸¦ JWTâ€‹â€‹ â†’ æœåŠ¡ç«¯éªŒè¯ JWT â†’ æˆæƒè®¿é—®ã€‚
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚                                                    â”‚          â”‚
â”‚  å®¢æˆ·ç«¯  â”‚                                                    â”‚  æœåŠ¡å™¨  â”‚
â”‚          â”‚                                                    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                                               â”‚
      â”‚  1. å‘é€ç™»å½•è¯·æ±‚ (ç”¨æˆ·å/å¯†ç )                                â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
      â”‚                                                               â”‚
      â”‚                                                               â”‚ 2. éªŒè¯å‡­æ®
      â”‚                                                               â”‚
      â”‚  3. è¿”å›JWTä»¤ç‰Œ                                               â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
      â”‚                                                               â”‚
      â”‚  4. å­˜å‚¨JWTä»¤ç‰Œ (localStorage/Cookie)                         â”‚
      â”‚                                                               â”‚
      â”‚  5. æºå¸¦JWTä»¤ç‰Œå‘é€APIè¯·æ±‚                                    â”‚
      â”‚    Authorization: Bearer {token}                              â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
      â”‚                                                               â”‚
      â”‚                                                               â”‚ 6. éªŒè¯JWTä»¤ç‰Œ
      â”‚                                                               â”‚
      â”‚                                                               â”‚ 7. æå–ç”¨æˆ·ä¿¡æ¯
      â”‚                                                               â”‚
      â”‚  8. è¿”å›å—ä¿æŠ¤çš„èµ„æº                                          â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
      â”‚                                                               â”‚
```

### JWTçš„ä¼˜ç¼ºç‚¹

#### ä¼˜ç‚¹ï¼š
1. **æ— çŠ¶æ€**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ä¼šè¯ä¿¡æ¯ï¼Œå‡è½»äº†æœåŠ¡å™¨è´Ÿæ‹…
2. **è·¨åŸŸ**ï¼šå¯ä»¥è½»æ¾å®ç°è·¨åŸŸè®¤è¯
3. **å¯æ‰©å±•æ€§**ï¼šæ˜“äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°è®¤è¯
4. **ç§»åŠ¨ç«¯å‹å¥½**ï¼šé€‚ç”¨äºç§»åŠ¨åº”ç”¨APIè®¤è¯

#### ç¼ºç‚¹ï¼š
1. **ä»¤ç‰Œå¤§å°**ï¼šJWTå¯èƒ½æ¯”ä¼ ç»Ÿçš„ä¼šè¯IDæ›´å¤§
2. **æ— æ³•æ’¤é”€**ï¼šç­¾å‘åæ— æ³•åœ¨åˆ°æœŸå‰æ’¤é”€ï¼ˆé™¤éå®ç°é»‘åå•ï¼‰
3. **æ•æ„Ÿæ•°æ®**ï¼šä¸åº”åœ¨JWTçš„è´Ÿè½½ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯
4. **å¤æ‚æ€§**ï¼šå®ç°å’Œç®¡ç†å¯èƒ½æ¯”ä¼ ç»Ÿä¼šè¯å¤æ‚

### æœ€ä½³å®è·µ
1. **é€‚å½“çš„è¿‡æœŸæ—¶é—´**ï¼šè®¾ç½®åˆç†çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸å‡ å°æ—¶åˆ°å‡ å¤©ï¼‰
2. **ä½¿ç”¨HTTPS**ï¼šå§‹ç»ˆé€šè¿‡HTTPSä¼ è¾“JWT
3. **åˆ·æ–°ä»¤ç‰Œ**ï¼šå®ç°åˆ·æ–°ä»¤ç‰Œæœºåˆ¶ï¼Œä»¥ä¾¿é•¿æœŸä¿æŒç”¨æˆ·ç™»å½•çŠ¶æ€
4. **å¯†é’¥ç®¡ç†**ï¼šä½¿ç”¨å¼ºå¥çš„å¯†é’¥ï¼Œå¹¶å®šæœŸæ›´æ¢
5. **è´Ÿè½½å¤§å°**ï¼šä¿æŒJWTè´Ÿè½½å°ï¼ŒåªåŒ…å«å¿…è¦ä¿¡æ¯
6. **é”™è¯¯å¤„ç†**ï¼šå®ç°å®Œå–„çš„JWTé”™è¯¯å¤„ç†æœºåˆ¶
7. **æƒé™æ§åˆ¶**ï¼šç»“åˆJWTå®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

### å®é™…åº”ç”¨ä¸­çš„æ³¨æ„äº‹é¡¹
1. **ä»¤ç‰Œå­˜å‚¨**ï¼šåœ¨æµè§ˆå™¨ä¸­é€šå¸¸å­˜å‚¨åœ¨localStorageæˆ–HttpOnly Cookieä¸­ï¼ˆåè€…æ›´å®‰å…¨ï¼‰
2. **å¹¶å‘å¤„ç†**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶ä½¿ç”¨ç›¸åŒçš„JWTæ—¶å¯èƒ½å‡ºç°å¹¶å‘é—®é¢˜
3. **ç»­ç­¾ç­–ç•¥**ï¼šå†³å®šä½•æ—¶ä»¥åŠå¦‚ä½•ç»­ç­¾ä»¤ç‰Œ
4. **å®‰å…¨æªæ–½**ï¼šé˜²æ­¢XSSã€CSRFç­‰æ”»å‡»ï¼Œä¿æŠ¤JWTçš„å®‰å…¨

æˆ‘ä»¬çš„å•†åŸå°ç¨‹åºé¡¹ç›®ä¸­ï¼Œé€šè¿‡æ­£ç¡®é…ç½®JWTå‚æ•°å’Œåˆ›å»ºåˆé€‚çš„ä¸­é—´ä»¶ï¼ŒæˆåŠŸå®ç°äº†åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶å’Œæ— çŠ¶æ€çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿã€‚

## æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

1. **ç¯å¢ƒå˜é‡ç®¡ç†**
   - æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½åº”åœ¨å„ç¯å¢ƒé…ç½®æ–‡ä»¶ä¸­æ˜ç¡®è®¾ç½®
   - å…³é”®å®‰å…¨å‚æ•°ï¼ˆå¦‚JWTå¯†é’¥ï¼‰åœ¨ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨å¼ºéšæœºå€¼
   - ä½¿ç”¨ç¯å¢ƒå˜é‡å‰åº”è¿›è¡Œå­˜åœ¨æ€§æ£€æŸ¥æˆ–æä¾›é»˜è®¤å€¼

2. **å‰åç«¯åˆ†ç¦»æ¶æ„**
   - å‰ç«¯å’Œåç«¯åº”åˆ†åˆ«åœ¨ä¸åŒç«¯å£è¿è¡Œï¼Œé€šè¿‡ä»£ç†è§£å†³è·¨åŸŸé—®é¢˜
   - APIè·¯å¾„è®¾è®¡åº”ä¿æŒä¸€è‡´æ€§ï¼Œé¿å…æ··æ·†

3. **å®‰å…¨å®è·µ**
   - JWTå¯†é’¥åº”ä¸ºå¤æ‚éšæœºå­—ç¬¦ä¸²ï¼Œä¸”åœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨ä¸åŒå€¼
   - ç”Ÿäº§ç¯å¢ƒå¯†ç åº”éµå¾ªå¼ºå¯†ç è§„åˆ™
   - æ•æ„Ÿé…ç½®ä¸åº”æäº¤åˆ°ä»£ç ä»“åº“ï¼Œå»ºè®®ä½¿ç”¨.env.localæˆ–ä¸“é—¨çš„å¯†é’¥ç®¡ç†æœåŠ¡ 

# å•†åŸå°ç¨‹åºè®¢å•æ”¯ä»˜æµç¨‹é—®é¢˜è®°å½•

## è®¢å•æäº¤åˆ°æ”¯ä»˜åˆ°ç”Ÿæˆè®¢å•çš„å®Œæ•´æµç¨‹

ç”¨å¼€å¥¶èŒ¶åº—çš„æµç¨‹æ¥æ¯”å–»ï¼Œä½ å°±æ˜ç™½å•¦ï¼ï¼ˆåˆ†æ­¥éª¤å›¾è§£ï¼‰

ğŸ‘‡ æ•´ä¸ªæµç¨‹å°±åƒç‚¹å¥¶èŒ¶ ğŸ‘‡

â€‹â€‹1. é€‰å¥¶èŒ¶ä¸‹å•ï¼ˆå‰ç«¯ï¼‰â€‹â€‹

ä½ ï¼šåœ¨èœå•ä¸Šé€‰å¥½å¥¶èŒ¶å£å‘³ï¼ˆé€‰å•†å“ï¼‰
æœåŠ¡å‘˜(å‰ç«¯)ï¼šè®°ä¸‹ä½ çš„è¦æ±‚ï¼Œæ‰“ç”µè¯é—®åå¨æœ‰æ²¡æœ‰ææ–™ï¼ˆæ£€æŸ¥åº“å­˜ï¼‰
ä½ ï¼šç‚¹å‡»ã€å»ç»“ç®—ã€‘æŒ‰é’®
â€‹â€‹2. åå¨åšå•å­ï¼ˆåç«¯ï¼‰â€‹â€‹

åº—é•¿(åç«¯)ï¼šæ”¶åˆ°è®¢å•
â‘  æ£€æŸ¥æ˜¯ä¸æ˜¯é‡å¤è®¢å•ï¼ˆé˜²é‡å¤æäº¤ï¼‰
â‘¡ åœ¨è´¦æœ¬ä¸Šå†™ï¼šâ€‹â€‹è®¢å•å·9527â€‹â€‹ï¼ˆç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼‰
â‘¢ ç®—æ€»ä»·ï¼šå¥¶èŒ¶25å…ƒ + åŒ…è£…è´¹2å…ƒï¼ˆè®¡ç®—é‡‘é¢ï¼‰
â€‹â€‹3. æ”¶é“¶å°ä»˜æ¬¾ï¼ˆå‰åç«¯é…åˆï¼‰â€‹â€‹

æ”¶é“¶å‘˜(å‰ç«¯)ï¼š
â‘  æ˜¾ç¤ºä»˜æ¬¾ç ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ç•Œé¢ï¼‰
â‘¡ æ‹¿æ‰«ç æªæ‰«ä½ çš„ä»˜æ¬¾ç ï¼ˆè°ƒç”¨æ”¯ä»˜æ¥å£ï¼‰
è´¢åŠ¡(åç«¯)ï¼š
â‘  è”ç³»å¾®ä¿¡/æ”¯ä»˜å®é“¶è¡ŒæŸ¥é’±åˆ°è´¦æ²¡ï¼ˆæ”¯ä»˜å›è°ƒï¼‰
â‘¡ åœ¨è®¢å•9527ä¸Šç›–ã€å·²ä»˜æ¬¾ã€‘ç« ï¼ˆæ›´æ–°è®¢å•çŠ¶æ€ï¼‰
â€‹â€‹4. å‡ºé¤å®Œæˆï¼ˆåç«¯é€šçŸ¥å‰ç«¯ï¼‰â€‹â€‹

åå¨(åç«¯)ï¼šé€šè¿‡å–‡å­å–Šã€Œè®¢å•9527å®Œæˆå•¦ï¼ã€ï¼ˆæ¨é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯ï¼‰
æœåŠ¡å‘˜(å‰ç«¯)ï¼šæŠŠå¥¶èŒ¶é€’ç»™ä½ ï¼ˆè·³è½¬åˆ°è®¢å•æˆåŠŸé¡µï¼‰
â€‹â€‹âœ¨ é‡ç‚¹è®°å¿†â€‹â€‹

å‰ç«¯=æœåŠ¡å‘˜ï¼šè´Ÿè´£å’Œä½ æ²Ÿé€šï¼Œå±•ç¤ºç•Œé¢
åç«¯=åå¨+è´¢åŠ¡ï¼šé»˜é»˜å¤„ç†è®¢å•ã€ç®¡é’±ã€å­˜æ•°æ®
æ”¯ä»˜å¹³å°=é“¶è¡Œï¼šä¸“é—¨è´Ÿè´£èµ„é‡‘äº¤æ˜“

### 1. è®¢å•ç¡®è®¤é˜¶æ®µ

**ç”¨æˆ·æ“ä½œæµç¨‹ï¼š**
1. ç”¨æˆ·åœ¨è´­ç‰©è½¦é¡µé¢é€‰æ‹©å•†å“å¹¶ç‚¹å‡»"ç»“ç®—"æŒ‰é’®
2. ç³»ç»Ÿè·³è½¬åˆ°è®¢å•ç¡®è®¤é¡µé¢ï¼Œå±•ç¤ºï¼š
   - æ”¶è´§åœ°å€ä¿¡æ¯
   - å•†å“æ¸…å•ï¼ˆå·²é€‰ä¸­çš„å•†å“ï¼‰
   - è®¢å•å¤‡æ³¨è¾“å…¥æ¡†
   - æ”¯ä»˜æ–¹å¼é€‰æ‹©ï¼ˆå¾®ä¿¡æ”¯ä»˜ï¼‰
   - ä»·æ ¼æ˜ç»†ï¼ˆå•†å“é‡‘é¢ã€è¿è´¹ã€ä¼˜æƒ ç­‰ï¼‰
   - å®ä»˜æ¬¾æ€»é¢

### 2. æäº¤è®¢å•é˜¶æ®µ

**ç”¨æˆ·æ“ä½œæµç¨‹ï¼š**
1. ç”¨æˆ·åœ¨ç¡®è®¤ä¿¡æ¯æ— è¯¯åç‚¹å‡»"æäº¤è®¢å•"æŒ‰é’®
2. å‰ç«¯è°ƒç”¨åˆ›å»ºè®¢å•APIï¼š`POST /api/order`ï¼Œä¼ é€’ä»¥ä¸‹å‚æ•°ï¼š
   - address_id: æ”¶è´§åœ°å€ID
   - remark: è®¢å•å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

**åç«¯å¤„ç†æµç¨‹ï¼š**
1. æ¥æ”¶è®¢å•è¯·æ±‚ï¼ŒéªŒè¯å‚æ•°
2. æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è´­ç‰©è½¦ä¸­å·²é€‰ä¸­çš„å•†å“
3. è®¡ç®—è®¢å•é‡‘é¢ï¼ˆå•†å“æ€»ä»·ã€è¿è´¹ç­‰ï¼‰
4. ç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼ˆå¦‚ï¼šæŒ‰æ—¶é—´æˆ³+éšæœºæ•°ç”Ÿæˆï¼‰
5. åˆ›å»ºè®¢å•è®°å½•ï¼ŒçŠ¶æ€è®¾ä¸º"å¾…ä»˜æ¬¾"(0)
6. åˆ›å»ºè®¢å•å•†å“è®°å½•
7. æ¸…ç©ºç”¨æˆ·è´­ç‰©è½¦ä¸­å·²ä¸‹å•çš„å•†å“
8. è¿”å›è®¢å•IDå’Œè®¢å•å·

### 3. å‘èµ·æ”¯ä»˜é˜¶æ®µ

**ç”¨æˆ·æ“ä½œæµç¨‹ï¼š**
1. è®¢å•åˆ›å»ºæˆåŠŸåï¼Œç³»ç»Ÿè‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
2. é¡µé¢æ˜¾ç¤ºè®¢å•é‡‘é¢å’Œæ”¯ä»˜å€’è®¡æ—¶

**åœ¨å®é™…é¡¹ç›®ä¸­çš„æ”¯ä»˜æµç¨‹:**
1. å‰ç«¯è°ƒç”¨è·å–æ”¯ä»˜å‚æ•°APIï¼š`POST /api/pay/wxpay`ï¼Œä¼ é€’è®¢å•å·
2. åç«¯ç”Ÿæˆæ”¯ä»˜å‚æ•°ï¼ˆæ­¤å¤„éœ€è¦è°ƒç”¨å¾®ä¿¡æ”¯ä»˜APIï¼‰
3. å‰ç«¯æ¥æ”¶æ”¯ä»˜å‚æ•°ï¼Œè°ƒç”¨å¾®ä¿¡æ”¯ä»˜æ¥å£

**æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹:**
1. å‰ç«¯æ˜¾ç¤ºæ¨¡æ‹Ÿæ”¯ä»˜ç•Œé¢ï¼Œå±•ç¤ºè®¢å•é‡‘é¢
2. ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"æŒ‰é’®
3. å‰ç«¯è°ƒç”¨æ¨¡æ‹Ÿæ”¯ä»˜APIï¼Œæ— éœ€çœŸå®è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
4. å±•ç¤ºæ”¯ä»˜ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰

### 4. æ”¯ä»˜ç»“æœå¤„ç†é˜¶æ®µ

**ç”¨æˆ·æ“ä½œæµç¨‹ï¼š**
1. æ”¯ä»˜æˆåŠŸåï¼Œé¡µé¢æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸæç¤º
2. ç”¨æˆ·ç‚¹å‡»"å®Œæˆ"æŒ‰é’®ï¼Œç³»ç»Ÿè·³è½¬åˆ°è®¢å•è¯¦æƒ…æˆ–è®¢å•åˆ—è¡¨é¡µé¢

**åç«¯å¤„ç†æµç¨‹ï¼š**
1. æ¥æ”¶æ”¯ä»˜ç»“æœï¼ˆæ¨¡æ‹Ÿæ”¯ä»˜æ—¶é€šè¿‡APIç›´æ¥é€šçŸ¥ï¼‰
2. æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å¾…å‘è´§"(1)
3. è®°å½•æ”¯ä»˜æ—¶é—´(pay_time)
4. ç”Ÿæˆæ”¯ä»˜è®°å½•

### 5. è®¢å•ç”Ÿæˆåçš„çŠ¶æ€å˜åŒ–

è®¢å•çŠ¶æ€æµè½¬ï¼š
- 0: å¾…ä»˜æ¬¾ â€”â€” ç”¨æˆ·æäº¤è®¢å•åçš„åˆå§‹çŠ¶æ€
- 1: å¾…å‘è´§ â€”â€” ç”¨æˆ·æ”¯ä»˜æˆåŠŸåçš„çŠ¶æ€
- 2: å¾…æ”¶è´§ â€”â€” å•†å®¶å‘è´§åçš„çŠ¶æ€
- 3: å·²å®Œæˆ â€”â€” ç”¨æˆ·ç¡®è®¤æ”¶è´§åçš„çŠ¶æ€
- 4: å·²å–æ¶ˆ â€”â€” ç”¨æˆ·å–æ¶ˆè®¢å•æˆ–è¶…æ—¶æœªæ”¯ä»˜

## æ¨¡æ‹Ÿæ”¯ä»˜åŠŸèƒ½å®ç°æ–¹æ¡ˆ

### å‰ç«¯å®ç°ï¼š

```javascript
// æ¨¡æ‹Ÿæ”¯ä»˜å‡½æ•°
function mockPayment(orderNo, amount) {
  return new Promise((resolve) => {
    wx.showModal({
      title: 'æ¨¡æ‹Ÿæ”¯ä»˜',
      content: `è®¢å•å·ï¼š${orderNo}\næ”¯ä»˜é‡‘é¢ï¼šÂ¥${amount}`,
      cancelText: 'å–æ¶ˆæ”¯ä»˜',
      confirmText: 'ç¡®è®¤æ”¯ä»˜',
      success(res) {
        if (res.confirm) {
          // è°ƒç”¨åç«¯æ”¯ä»˜æˆåŠŸæ¥å£
          updateOrderPayStatus(orderNo, true).then(() => {
            resolve({status: 'success'});
          });
        } else {
          resolve({status: 'cancel'});
        }
      }
    });
  });
}
```

### åç«¯å®ç°ï¼š

```javascript
// æ¨¡æ‹Ÿæ”¯ä»˜ç»“æœæ›´æ–°API
exports.updateOrderPayStatus = async (req, res) => {
  const { order_no, status } = req.body;
  
  try {
    const order = await Order.findOne({ where: { order_no } });
    
    if (!order) {
      return res.status(404).json({
        code: 404,
        message: 'è®¢å•ä¸å­˜åœ¨'
      });
    }
    
    if (status) {
      // æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°è®¢å•çŠ¶æ€
      await Order.update({
        status: 1,  // å¾…å‘è´§
        pay_time: new Date()
      }, {
        where: { order_no }
      });
    }
    
    return res.json({
      code: 200,
      message: 'æ›´æ–°æˆåŠŸ',
      data: null
    });
  } catch (error) {
    return res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨é”™è¯¯'
    });
  }
};
```

é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œå¯ä»¥å®Œæ•´æ¨¡æ‹Ÿæ•´ä¸ªè®¢å•æ”¯ä»˜æµç¨‹ï¼Œè€Œæ— éœ€å®é™…é›†æˆå¾®ä¿¡æ”¯ä»˜APIï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•é˜¶æ®µä½¿ç”¨ã€‚ 

# å•†åŸå°ç¨‹åºå¼€å‘è¿‡ç¨‹ä¸­çš„é—®é¢˜è®°å½•

## è®¾ç½®é»˜è®¤åœ°å€APIè°ƒç”¨æ–¹å¼ä¸åŒï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªèƒ½æˆåŠŸï¼Œä¸€ä¸ªä¸èƒ½ï¼Ÿ

### é—®é¢˜æè¿°

åœ¨å°ç¨‹åºçš„åœ°å€APIè°ƒç”¨ä¸­ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼è°ƒç”¨è®¾ç½®é»˜è®¤åœ°å€çš„APIï¼š

```javascript
// æ–¹å¼1ï¼šä¸å¯è¡Œ
request.put(api.AddressDefault, { id });

// æ–¹å¼2ï¼šå¯è¡Œ
request.put(`${api.AddressDefault}/${id}`);
```

ä½†æ˜¯åªæœ‰ç¬¬äºŒç§æ–¹æ³•å¯ä»¥æˆåŠŸè®¾ç½®é»˜è®¤åœ°å€ï¼Œç¬¬ä¸€ç§æ–¹æ³•ä¼šå¤±è´¥ã€‚

### åŸå› åˆ†æ

é—®é¢˜çš„æ ¹æœ¬åŸå› åœ¨äºåç«¯è·¯ç”±ä¸APIè°ƒç”¨æ–¹å¼çš„åŒ¹é…ï¼š

1. **åç«¯è·¯ç”±å®šä¹‰**ï¼š
   ```javascript
   // PUT /api/address/default/:id
   router.put('/default/:id', protect, addressController.setDefaultAddress);
   ```

2. **ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«**ï¼š
   
   - **æ–¹æ³•ä¸€ï¼ˆæ— æ•ˆï¼‰**ï¼š
     - å‘é€è¯·æ±‚åˆ° `http://127.0.0.1:8080/api/address/default`
     - IDè¢«æ”¾åœ¨è¯·æ±‚ä½“(body)ä¸­ä½œä¸ºJSONæ•°æ® `{ id: æŸä¸ªå€¼ }`
     - æœåŠ¡å™¨æ‰¾ä¸åˆ°åŒ¹é…çš„è·¯ç”±ï¼Œå› ä¸ºå®ƒéœ€è¦IDä½œä¸ºURLè·¯å¾„çš„ä¸€éƒ¨åˆ†
   
   - **æ–¹æ³•äºŒï¼ˆæœ‰æ•ˆï¼‰**ï¼š
     - å‘é€è¯·æ±‚åˆ° `http://127.0.0.1:8080/api/address/default/æŸä¸ªIDå€¼`
     - IDä½œä¸ºURLè·¯å¾„çš„ä¸€éƒ¨åˆ†
     - å®Œå…¨åŒ¹é…æœåŠ¡å™¨ç«¯å®šä¹‰çš„è·¯ç”±æ ¼å¼ `/default/:id`

### RESTful APIè®¾è®¡è¯´æ˜

è¿™æ˜¯RESTful APIè®¾è®¡çš„é‡è¦è§„èŒƒï¼š

1. **è·¯å¾„å‚æ•°ï¼ˆPath Parametersï¼‰**ï¼šç”¨äºæ ‡è¯†è¦æ“ä½œçš„èµ„æº
   - æ ¼å¼ï¼š`/users/123`ã€`/products/456`
   - ç”¨é€”ï¼šåœ¨URLè·¯å¾„ä¸­æŒ‡å®šè¦æ“ä½œçš„èµ„æºID

2. **è¯·æ±‚ä½“å‚æ•°ï¼ˆBody Parametersï¼‰**ï¼šç”¨äºä¼ é€’æ•°æ®å†…å®¹
   - æ ¼å¼ï¼š`{ "name": "å¼ ä¸‰", "age": 30 }`
   - ç”¨é€”ï¼šä¼ é€’è¦åˆ›å»ºæˆ–æ›´æ–°çš„å…·ä½“æ•°æ®

æ ¹æ®RESTfulåŸåˆ™ï¼ŒIDæ˜¯ç”¨æ¥æ ‡è¯†ç‰¹å®šèµ„æºçš„ï¼Œåº”è¯¥ä½œä¸ºè·¯å¾„å‚æ•°ï¼Œè€Œä¸æ˜¯è¯·æ±‚ä½“å‚æ•°ã€‚

### è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹å°ç¨‹åºçš„`address.js`æ–‡ä»¶ä¸­çš„`setDefaultAddress`å‡½æ•°ï¼š

```javascript
function setDefaultAddress(id) {
    // åˆ é™¤æˆ–æ³¨é‡Šæ‰æ— æ•ˆçš„æ–¹æ³•
    // return request.put(api.AddressDefault, { id });
    
    // ä½¿ç”¨æœ‰æ•ˆçš„æ–¹æ³•
    return request.put(`${api.AddressDefault}/${id}`);
}
```

### å…¶ä»–æ³¨æ„äº‹é¡¹

1. ç¡®ä¿APIè·¯å¾„å®šä¹‰å’Œè°ƒç”¨æ–¹å¼ä¿æŒä¸€è‡´
2. è®¾è®¡APIæ—¶ï¼Œæ˜ç¡®åŒºåˆ†è·¯å¾„å‚æ•°å’Œè¯·æ±‚ä½“å‚æ•°çš„ç”¨é€”
3. å¦‚æœéœ€è¦ä»è¯·æ±‚ä½“è·å–IDï¼Œåç«¯è·¯ç”±å’Œæ§åˆ¶å™¨ä¹Ÿéœ€è¦ç›¸åº”è°ƒæ•´